name: Create Cluster

on:
  - pull_request
  - push

jobs:
  create-cluster:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.3.0
        config: ./helm/ci/kind.yml

      - name: Install helm chart
        run: helm install test-release helm/oncall --values helm/ci/simple.yml

      - name: Await jupyterhub
        uses: jupyterhub/action-k8s-await-workloads@v1
        with:
          workloads: "" # all
          namespace: "" # default
          timeout: 300
          max-restarts: 0

      - name: Ping
        run: curl http://localhost:30001

      # GitHub Action reference: https://github.com/jupyterhub/action-k8s-namespace-report
      - name: Kubernetes namespace report
        uses: jupyterhub/action-k8s-namespace-report@v1
        if: always()
      # with:
      #   namespace: my-namespace
      #   pod-selector: app.kubernetes.io/component notin (secret-server,boring-server)
      #   important-workloads: deploy/my-deployment sts/my-statefulset